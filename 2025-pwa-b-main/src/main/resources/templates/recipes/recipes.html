<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <th:block th:replace="~{fragments/head :: common-head}"></th:block>
    <title>Recettes - ECO Cook</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/recipes.css}">
</head>
<body>
    <!-- NAVBAR -->
    <div th:replace="~{fragments/header :: navbar}"></div>
    
    <!-- HERO HEADER -->
    <section class="recipes-hero">
        <div class="container">
            <div class="hero-content-recipes">
                <div class="hero-badge-recipes">
                    <i class="fas fa-utensils"></i>
                    Découvrez nos recettes
                </div>
                <h1 class="hero-title-recipes">Suggestions de Recettes</h1>
                <p class="hero-subtitle-recipes">
                    Découvrez ce que vous pouvez cuisiner avec votre stock actuel et réduisez le gaspillage alimentaire
                </p>
                <div class="hero-actions" id="create-recipe-btn" style="display: none;">
                    <a th:href="@{/recipes/new}" class="btn-create-recipe">
                        <i class="fas fa-plus"></i>
                        <span>Créer une recette</span>
                    </a>
                </div>
            </div>
        </div>
    </section>
    
    <!-- LOADING STATE -->
    <section class="section" id="loading-section">
        <div class="container">
            <div class="empty-state-modern">
                <div class="empty-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <h2 class="empty-title">Chargement des recettes...</h2>
            </div>
        </div>
    </section>
    
    <!-- ERROR STATE -->
    <section class="section" id="error-section" style="display: none;">
        <div class="container">
            <div class="message-alert error">
                <i class="fas fa-exclamation-circle"></i>
                <span id="error-message"></span>
            </div>
        </div>
    </section>
    
    <!-- RECETTES 100% DISPONIBLES -->
    <section class="section recipes-section" id="fully-available-section" style="display: none;">
        <div class="container">
            <div class="section-header-custom success">
                <div class="section-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="section-info">
                    <h2 class="section-title-custom">
                        Recettes réalisables maintenant
                        <span class="count-badge success" id="fully-count">0</span>
                    </h2>
                    <p class="section-description-custom">Vous avez tous les ingrédients nécessaires !</p>
                </div>
            </div>
            
            <div class="recipes-grid" id="fully-available-grid"></div>
        </div>
    </section>
    
    <!-- RECETTES PARTIELLEMENT DISPONIBLES -->
    <section class="section recipes-section" id="partially-available-section" style="display: none;">
        <div class="container">
            <div class="section-header-custom warning">
                <div class="section-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="section-info">
                    <h2 class="section-title-custom">
                        Recettes partiellement réalisables
                        <span class="count-badge warning" id="partially-count">0</span>
                    </h2>
                    <p class="section-description-custom">Il vous manque quelques ingrédients</p>
                </div>
            </div>
            
            <div class="recipes-grid" id="partially-available-grid"></div>
        </div>
    </section>
    
    <!-- RECETTES NON DISPONIBLES -->
    <section class="section recipes-section" id="not-available-section" style="display: none;">
        <div class="container">
            <div class="section-header-custom danger">
                <div class="section-icon">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="section-info">
                    <h2 class="section-title-custom">
                        Autres recettes
                        <span class="count-badge danger" id="not-count">0</span>
                    </h2>
                    <p class="section-description-custom">Faites vos courses pour réaliser ces recettes</p>
                </div>
            </div>
            
            <div class="recipes-grid-compact" id="not-available-grid"></div>
        </div>
    </section>
    
    <!-- EMPTY STATE -->
    <section class="section" id="empty-section" style="display: none;">
        <div class="container">
            <div class="empty-state-modern">
                <div class="empty-icon">
                    <i class="fas fa-book-open"></i>
                </div>
                <h2 class="empty-title">Aucune recette pour le moment</h2>
                <p class="empty-subtitle">Créez votre première recette pour commencer votre aventure culinaire anti-gaspi !</p>
                <a th:href="@{/recipes/new}" class="btn-empty-action" id="empty-create-btn" style="display: none;">
                    <i class="fas fa-plus"></i>
                    <span>Créer ma première recette</span>
                </a>
            </div>
        </div>
    </section>
    
    <!-- FOOTER -->
    <div th:replace="~{fragments/footer :: footer}"></div>
    
    <div th:replace="~{fragments/header :: navbar-scripts}"></div>
    
    <!-- JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadRecipes();
        });
        
        function loadRecipes() {
            // Afficher le loading
            document.getElementById('loading-section').style.display = 'block';
            document.getElementById('error-section').style.display = 'none';
            
            fetch('/recipes/api/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur lors du chargement des recettes');
                    }
                    return response.json();
                })
                .then(data => {
                    // Masquer le loading
                    document.getElementById('loading-section').style.display = 'none';
                    
                    // Afficher le bouton créer si authentifié
                    if (data.isAuthenticated) {
                        document.getElementById('create-recipe-btn').style.display = 'block';
                        document.getElementById('empty-create-btn').style.display = 'inline-flex';
                    }
                    
                    // Afficher les recettes
                    displayRecipes(data);
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    document.getElementById('loading-section').style.display = 'none';
                    document.getElementById('error-section').style.display = 'block';
                    document.getElementById('error-message').textContent = 'Impossible de charger les recettes. Veuillez réessayer.';
                });
        }
        
        function displayRecipes(data) {
            const fullyAvailable = data.fullyAvailable || [];
            const partiallyAvailable = data.partiallyAvailable || [];
            const notAvailable = data.notAvailable || [];
            const totalRecipes = data.totalRecipes || 0;
            
            // Si aucune recette
            if (totalRecipes === 0) {
                document.getElementById('empty-section').style.display = 'block';
                return;
            }
            
            // Recettes 100% disponibles
            if (fullyAvailable.length > 0) {
                document.getElementById('fully-available-section').style.display = 'block';
                document.getElementById('fully-count').textContent = fullyAvailable.length;
                const grid = document.getElementById('fully-available-grid');
                grid.innerHTML = '';
                fullyAvailable.forEach(match => {
                    grid.appendChild(createFullRecipeCard(match));
                });
            }
            
            // Recettes partiellement disponibles
            if (partiallyAvailable.length > 0) {
                document.getElementById('partially-available-section').style.display = 'block';
                document.getElementById('partially-count').textContent = partiallyAvailable.length;
                const grid = document.getElementById('partially-available-grid');
                grid.innerHTML = '';
                partiallyAvailable.forEach(match => {
                    grid.appendChild(createPartialRecipeCard(match));
                });
            }
            
            // Recettes non disponibles
            if (notAvailable.length > 0 && data.isAuthenticated) {
                document.getElementById('not-available-section').style.display = 'block';
                document.getElementById('not-count').textContent = notAvailable.length;
                const grid = document.getElementById('not-available-grid');
                grid.innerHTML = '';
                notAvailable.forEach(match => {
                    grid.appendChild(createCompactRecipeCard(match));
                });
            }
        }
        
        function createFullRecipeCard(match) {
            const card = document.createElement('div');
            card.className = 'recipe-card-modern';
            
            card.innerHTML = `
                <div class="recipe-header">
                    <div class="recipe-info">
                        <h3 class="recipe-title">${escapeHtml(match.recipe.name)}</h3>
                        <p class="recipe-description">${escapeHtml(match.recipe.description)}</p>
                    </div>
                    <div class="recipe-badge">
                        <span class="availability-pill success">
                            <i class="fas fa-check"></i>
                            100% disponible
                        </span>
                    </div>
                </div>
                
                <div class="recipe-meta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${match.recipe.totalTime} min</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>${match.recipe.servings} pers.</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-chart-line"></i>
                        <span>${escapeHtml(match.recipe.difficulty)}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-utensils"></i>
                        <span>${escapeHtml(match.recipe.category)}</span>
                    </div>
                </div>
                
                <div class="recipe-ingredients-preview">
                    <strong class="ingredients-title">
                        <i class="fas fa-check-circle"></i>
                        Ingrédients disponibles
                    </strong>
                    <div class="ingredients-tags">
                        ${match.matchedIngredients.map(ing => `
                            <span class="ingredient-tag available">
                                <i class="fas fa-check"></i>
                                <span>${escapeHtml(ing.name)}</span>
                            </span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="recipe-actions">
                    <a href="/recipes/${match.recipe.id}" class="btn-recipe-view">
                        <i class="fas fa-eye"></i>
                        <span>Voir la recette</span>
                    </a>
                </div>
            `;
            
            return card;
        }
        
        function createPartialRecipeCard(match) {
            const card = document.createElement('div');
            card.className = 'recipe-card-modern';
            
            card.innerHTML = `
                <div class="recipe-header">
                    <div class="recipe-info">
                        <h3 class="recipe-title">${escapeHtml(match.recipe.name)}</h3>
                        <p class="recipe-description">${escapeHtml(match.recipe.description)}</p>
                    </div>
                    <div class="recipe-badge">
                        <span class="availability-pill warning">
                            <i class="fas fa-exclamation-circle"></i>
                            ${Math.round(match.matchPercentage)}% disponible
                        </span>
                    </div>
                </div>
                
                <div class="recipe-meta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>${match.recipe.totalTime} min</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-users"></i>
                        <span>${match.recipe.servings} pers.</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-chart-line"></i>
                        <span>${escapeHtml(match.recipe.difficulty)}</span>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-utensils"></i>
                        <span>${escapeHtml(match.recipe.category)}</span>
                    </div>
                </div>
                
                <div class="ingredients-comparison">
                    <div class="ingredients-section has">
                        <strong class="ingredients-title success">
                            <i class="fas fa-check"></i>
                            Vous avez
                        </strong>
                        <div class="ingredients-tags">
                            ${match.matchedIngredients.map(ing => `
                                <span class="ingredient-tag available">
                                    <span>${escapeHtml(ing.name)}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="ingredients-section missing">
                        <strong class="ingredients-title danger">
                            <i class="fas fa-times"></i>
                            Il manque
                        </strong>
                        <div class="ingredients-tags">
                            ${match.missingIngredients.map(ing => `
                                <span class="ingredient-tag missing">
                                    <span>${escapeHtml(ing.name)}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                </div>
                
                <div class="recipe-actions">
                    <a href="/recipes/${match.recipe.id}" class="btn-recipe-view secondary">
                        <i class="fas fa-eye"></i>
                        <span>Voir la recette</span>
                    </a>
                </div>
            `;
            
            return card;
        }
        
        function createCompactRecipeCard(match) {
            const card = document.createElement('div');
            card.className = 'recipe-card-compact';
            
            card.innerHTML = `
                <div class="compact-header">
                    <h4 class="compact-title">${escapeHtml(match.recipe.name)}</h4>
                    <span class="availability-pill-small danger">
                        ${Math.round(match.matchPercentage)}%
                    </span>
                </div>
                <div class="compact-meta">
                    <span>${escapeHtml(match.recipe.category)}</span>
                    <span>•</span>
                    <span>${match.recipe.totalTime} min</span>
                </div>
                <a href="/recipes/${match.recipe.id}" class="compact-link">
                    Voir la recette
                    <i class="fas fa-arrow-right"></i>
                </a>
            `;
            
            return card;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>